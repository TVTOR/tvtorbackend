<!DOCTYPE html>
<html lang="en">

<head>
	<title>convForm - example</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/jquery.convform.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
		integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="css/demo.css">
</head>

<body>
	<section id="demo">
		<div class="vertical-align">
			<div class="container">
				<div class="row">
					<div class="col-sm-6 col-sm-offset-3 col-xs-offset-0">
						<div class="card no-border">
							<div id="chat">
								<form action="" method="GET" class="hidden">
									<select data-conv-question="Hello! Welcome to Simon. May I help you?"
										name="first-question">
										<option value="yes">Yes</option>
										<option value="sure">Sure!</option>
									</select>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<script type="text/javascript" src="js/jquery-1.12.3.min.js"></script>
	<script type="text/javascript" src="js/autosize.min.js"></script>
	<script type="text/javascript" src="js/jquery.convform.js"></script>



	<script>
		jQuery(function ($) {
			const baseUrl = 'https://tutorbackend.herokuapp.com/api/v1';
			// const baseUrl = 'http://localhost:5000/api/v1';
			var userData = {};
			var isAssignTutor = true;
			var setIntervalTime;
			var newQuestion = '';
			var count = 2;
			var lastNext = 0;
			var url = `${baseUrl}/question`
			var convForm = $('#chat').convform({
				selectInputStyle: 'disable', eventList: {
					onInputSubmit: function (convState, ready) {
						get_question(convState, ready);
						if (userData.hasOwnProperty('email') && userData.hasOwnProperty('subject') && userData.hasOwnProperty('location')) {
							setIntervalTime = setInterval(() => {
								checkTutorAssignOrNot(convState, ready);
							}, 2000);
							setTimeout(function () {
								clearInterval(setIntervalTime);
								if (isAssignTutor) {
									assignTutor(convState, ready);
								}
							}, 60000);
						}
					}
				}
			});

			function locationCheck() {
				var checkLocationUrl = `${baseUrl}/getTutorsLocation`;
				jQuery.ajax({
					url: checkLocationUrl, async: true, method: 'post', data: userData, success: function (result) {
						if (result.statusCode == 404) {
							var que = "There is no tutor are available on this location";
							$('#messages').append('<div class="message to ready">' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 600 }, 600);
							return false;
						} else {
							return true;
						}
					}
				})
			}


			function checkTutorAssignOrNot(convState, ready) {
				var checkLocationUrl = `${baseUrl}/checkTutorAssignOrNot/${userData.email}`;
				jQuery.ajax({
					url: checkLocationUrl, async: true, method: 'get', data: userData, success: function (result) {
						if (result.data && isAssignTutor) {
							assignTutor(convState, ready);
						}
					}
				})
			}



			function assignTutor(convState, ready) {
				var assignTutorUrl = `${baseUrl}/getStudentTutor`;
				jQuery.ajax({
					url: assignTutorUrl, async: true, method: 'post', data: userData, success: function (result) {
						isAssignTutor = false;
						clearInterval(setIntervalTime);
						var que = "There is no tutor available right now. Thank you!";
						let image
						let name
						let surname
						if (result.success) {
							name = result.data.tutor.name;
							surname = result.data.tutor.surname;
							const email = result.data.tutor.email;
							const mobileNumber = result.data.tutor.mobileNumber;
							const profileImage = result.data.tutor.imageUrl;
							image = profileImage
							que = 'We have assigned ' + name + ' ' + surname + ' for your ' + userData['subject'] + ' subject and his email id is ' + email + ' and contact number is ' + mobileNumber + '. Thank you!'
						}
						if(image){
							$('#messages').append('<div class="message to ready"><img src=' + image + ' alt="" width="70" height="70"><figcaption>' + name + " " + surname + '</figcaption></div>').animate({ scrollTop: $("#messages").offset().top + 200 }, 200);
							$('#messages').append('<div class="message to ready">' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 600 }, 600);
						} else {
							$('#messages').append('<div class="message to ready">' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 600 }, 600);
						}
						// <img src="{{amenity.amenityLogo}}" alt="" width="50" height="50">
					}
				});
			}

			function get_question(convState, ready) {
				if (convState.current.answer.value === 'end') {
					convState.current.next = false;
					setTimeout(ready, Math.random() * 500 + 100);
				} else {
					if (Array.isArray(convState.current.answer)) {
						var answer = convState.current.answer.join(',');
						userData[convState.current.input.name] = answer;
					}
					else {
						var answer = convState.current.answer.text;
						userData[convState.current.input.name] = answer;
					}
					var queryString = '';
					for (var key in userData) {
						if (userData.hasOwnProperty(key)) {
							queryString += '&' + key + '=' + userData[key];
						}
					}
					jQuery.ajax({
						url, data: { question: count, email: userData.email, subject: userData.subject, location: userData.location, mobilenumber: userData.mobilenumber, name: userData.name, age: userData.age, website: userData.website }, async: false, method: 'post', success: function (result) {
							var qData = result.data.data;
							var pattern = '';
							for (var i = 0; i < qData.length; i++) {
								if (qData[i].title == 'email') {
									pattern = "^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$";
								}
								newQuestion = qData[i].question;
								count = qData[i].question_num;
								var questionTitle = qData[i].title;
								var newQuestion = newQuestion.replace("{name}", answer);

								if (qData[i].no_answer == 1) {
									convState.current.next = convState.newState({
										type: 'text',
										noAnswer: true,
										name: questionTitle,
										questions: [newQuestion],
									});
									lastNext = 1;
								} else {
									if (lastNext == 1) {
										lastNext = 0;
										if (qData[i].type == 'text') {
											convState.current.next.next = convState.newState({
												type: 'text',
												name: questionTitle,
												pattern: pattern,
												questions: [newQuestion],
											});
										} else {
											convState.current.next.next = convState.newState({
												type: 'select',
												name: questionTitle,
												questions: [newQuestion],
												answers: qData[i].options
											});
										}
									} else {
										if (qData[i].type == 'text') {
											convState.current.next = convState.newState({
												type: 'text',
												pattern: pattern,
												name: questionTitle,
												questions: [newQuestion],
											});

										} else {
											answersOption = qData[i].options;
											convState.current.next = convState.newState({
												type: 'select',
												name: questionTitle,
												questions: [newQuestion],
												answers: answersOption
											});
										}
									}
								}
							}
						}
					});
					setTimeout(ready, Math.random() * 500 + 500);
				}
				count++;
			}
		});
	</script>
</body>

</html>