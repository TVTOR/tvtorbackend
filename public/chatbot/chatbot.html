<!DOCTYPE html>
<html lang="en">

<head>
	<title>convForm - example</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/jquery.convform.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
		integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="css/demo.css">
</head>

<body>
	<select name="" id="languageChange">
		<option value="en">English</option>
		<option value="it">Italic</option>
	</select>
	<section id="demo">
		<div class="vertical-align">
			<div class="container">
				<div class="row">
					<div class="col-sm-6 col-sm-offset-3 col-xs-offset-0">
						<div class="card no-border">
							<div id="chat">
								<form action="" id="form-english" method="GET" class="hidden">
									<select id="question-data-en"
										data-conv-question="Hello! Welcome to Simon. May I help you?"
										name="first-question">
										<option value="yes">Yes</option>
										<option value="sure">Sure!</option>
									</select>
									<select id="question-data-it" style="display: none;"
										data-conv-question="Ciao, benvenuto su TVTOR, posso aiutarti a trovare un tutor?"
										name="first-question">
										<option value="si">si</option>
										<option value="sure">certo!</option>
									</select>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<script type="text/javascript" src="js/jquery-1.12.3.min.js"></script>
	<script type="text/javascript" src="js/autosize.min.js"></script>
	<script type="text/javascript" src="js/jquery.convform.js"></script>



	<script>
		$('#languageChange').on('change', function () {
			if ($('#languageChange').val() == 'it') {
				// $("#question-data-it").show();
				$('.message:first-child').html('')
				// $("#question-data-en").hide();
				$('.message:first-child').html('Ciao, benvenuto su TVTOR, posso aiutarti a trovare un tutor?')
				$("#convForm .option:first-child").html('si')
				$("#convForm .option:nth-child(2)").html('certo')


				// $(".message:nth-child(2)").html('si')
				$("#convForm .option:first-child").text('si')
				$("#convForm .option:nth-child(2)").text('certo')

				$("#convForm .option:first-child").val('si')
				$("#convForm .option:nth-child(2)").val('certo')
				if ($("#userInput").attr("placeholder") == "Select an option") {
					$("#userInput").attr("placeholder", "seleziona un'opzione");
				} else {
					alert('=====change italic======')
					$("textarea#userInput").attr("placeholder", "digita qui");

				}
				// $("#userInput").attr("placeholder", "seleziona un'opzione");
				// $("#userInput").attr("placeholder", "digita qui");
				$(".submit").html('invia');

			} else {
				// $("#question-data-it").show();
				$('.message:first-child').html('')
				// $("#question-data-en").hide();
				$('.message:first-child').html('Hello! Welcome to Simon. May I help you?')
				$("#convForm .option:first-child").html('Yes')
				$("#convForm .option:nth-child(2)").html('Sure')
				$(".option:first-child").html('Yes')
				$(".option:nth-child(2)").html('Sure')
				if ($("#userInput").attr("placeholder") == "Select an option") {
					$("#userInput").attr("placeholder", "Select an option");
				} else {
					// alert('====type here====')
					$("textarea#userInput").attr("placeholder", "Type here");

				}
				$(".submit").html('Send');
			}
		});
		jQuery(function ($) {
			const baseUrl = 'https://tutorbackend.herokuapp.com/api/v1';
			// const baseUrl = 'http://localhost:5000/api/v1';
			var userData = {};
			var isAssignTutor = true;
			var isAssignTutor_check = true;
			var setIntervalTime;
			var newQuestion = '';
			var count = 2;
			var lastNext = 0;
			let notificationId = ""
			var url = `${baseUrl}/question`
			var convForm = $('#chat').convform({
				selectInputStyle: 'disable', eventList: {
					onInputSubmit: function (convState, ready) {
						// console.log('=====convState convState= start=========', convState)
						get_question(convState, ready);
						console.log('=====convState.current.input.name =========', convState.current.input.name)
						// $("button").click(function () {
						console.log('=======button click===========')
						if (convState.current.input.name != "name") {
							$("#chat").addClass("danger");
						}
						if (convState.current.input.name == "name") {
							$("#chat").removeClass("danger");

						}
						if (convState.current.input.name == "age") {
							$("#chat").removeClass("danger");

						}
						// });
						if (userData.hasOwnProperty('subject') && userData.hasOwnProperty('location')) {
							setIntervalTime = setInterval(() => {
								if (isAssignTutor) {
									checkTutorAssignOrNot(convState, ready);
								}
							}, 2000);
							setTimeout(function () {
								clearInterval(setIntervalTime);
								// if (isAssignTutor) {
								// assignTutor(convState, ready);
								// get_question(convState, ready);
								// }
							}, 60000);
						}
					}
				}
			});

			function locationCheck() {
				var checkLocationUrl = `${baseUrl}/getTutorsLocation`;
				jQuery.ajax({
					url: checkLocationUrl, async: true, method: 'post', data: userData, success: function (result) {
						if (result.statusCode == 404) {
							var que = "There is no tutor are available on this location";
							$('#messages').append('<div class="message to ready">' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 600 }, 600);
							return false;
						} else {
							return true;
						}
					}
				})
			}

			function checkTutorAssignOrNot(convState, ready) {
				var checkLocationUrl = `${baseUrl}/checkTutorAssignOrNot/${userData.email}`;
				if (isAssignTutor) {
					jQuery.ajax({
						url: checkLocationUrl, async: true, method: 'get', data: userData, success: function (result) {
							console.log('=======is Assign tutor=============', isAssignTutor)
							if (result.data && isAssignTutor && isAssignTutor_check) {
								isAssignTutor_check = false
								assignTutor(convState, ready);
							}

						}
					})
				}
				// jQuery.ajax({
				// 	url: checkLocationUrl, async: true, method: 'get', data: userData, success: function (result) {
				// 		if (result.data && isAssignTutor) {
				// 			assignTutor(convState, ready);
				// 		}
				// 	}
				// })
			}

			function assignTutor(convState, ready) {
				var assignTutorUrl = `${baseUrl}/getStudentTutor`;
				jQuery.ajax({
					url: assignTutorUrl, async: true, method: 'post', data: userData, success: function (result) {
						isAssignTutor = false;
						clearInterval(setIntervalTime);
						var que
						if ($('#languageChange').val() == 'en') {
							que = "There is no tutor available right now. Thank you!";
						} else if ($('#languageChange').val() == 'it') {
							que = "Non ci sono tutor disponibili al momento.";
						}
						let image
						let name
						let surname
						if (result.success) {
							name = result.data.tutor.name;
							surname = result.data.tutor.surname;
							const email = result.data.tutor.email;
							const mobileNumber = result.data.tutor.mobileNumber;
							const profileImage = result.data.tutor.imageUrl;
							notificationId = result.data.notificationId;
							image = profileImage
							if ($('#languageChange').val() == 'en') {
								que = 'We have assigned ' + name + ' ' + surname + ' for your ' + userData['subject'] + ' subject and his email id is ' + email + ' and contact number is ' + mobileNumber + '. Thank you!'
							} else if ($('#languageChange').val() == 'it') {
								que = 'Ti abbiamo assegnato ' + name + ' ' + surname + ' per ' + userData['subject'] + ' email ' + email + ' I suoi contatti sono: ' + mobileNumber + '.'

							}
						}
						if (image) {
							// $('#messages').append('<div class="message to ready"><img src=' + image + ' alt="" width="70" height="70"><figcaption>' + name + " " + surname + '</figcaption></div>').animate({ scrollTop: $("#messages").offset().top + 200 }, 200);
							console.log('=======is Assign tutor in image=============', isAssignTutor)
							$('#messages').append('<div class="message to ready image_size"><img src=' + image + ' alt="" width="70" height="70"><figcaption>' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);
							get_question(convState, ready);
						} else {
							$('#messages').append('<div class="message to ready">' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);
						}
					}
				});
			}

			function get_question(convState, ready) {
				console.log('=====get_question=start in =========', count)
				console.log('======convState.current.answer.value -------', convState.current.answer.value)
				if (convState.current.answer.value === 'end') {
					console.log("<<<<<<<<==========endquestions=========>>>>>>>>>>>>>>>")
					// convState.current.next = false;
					setTimeout(ready, Math.random() * 500 + 100);
				} else {
					if (Array.isArray(convState.current.answer)) {
						var answer = convState.current.answer.join(',');
						userData[convState.current.input.name] = answer;
					}
					else {
						var answer = convState.current.answer.text;
						userData[convState.current.input.name] = answer;
					}
					var queryString = '';
					console.log('========userData======', userData)
					// mobilenumber: "67676767"
					// name: "df"
					// subject: "Java"
					// website: "fggf"
					if (userData.age && userData.name && userData.subject && !userData.website) {
						var d = new Date();
						var n = d.getTime();
						var name = userData.name.replace(/\s/g, '')
						userData.email = n + name + "@gmail.com"
					}
					for (var key in userData) {
						if (userData.hasOwnProperty(key)) {
							console.log('========key======', userData)
							queryString += '&' + key + '=' + userData[key];
						}
					}
					// $(".messages .message:first-child").text('si')
					console.log('-----------------------', $('#languageChange :selected').val())
					console.log('========url========', url, $('#languageChange').val())
					jQuery.ajax({
						url, data: { language: $('#languageChange').val(), question: count, email: userData.email, subject: userData.subject, location: userData.location, mobilenumber: userData.mobilenumber, name: userData.name, age: userData.age, website: userData.website, notificationId: notificationId }, async: false, method: 'post', success: function (result) {
							var qData = result.data.data;
							console.log('=============qData in chatbot===', qData[0].type, qData.languageCode)
							if (qData[0].type == "select" && qData[0].languageCode == "it") {
								setTimeout(function () {
									// alert('it select qui')
									$("#userInput").attr("placeholder", "seleziona un'opzione");
								}, 2000);
							}
							else if (qData[0].type == "select" && qData[0].languageCode == "en") {
								setTimeout(function () {
									// alert('en select qui')
									$("#userInput").attr("placeholder", "Select an option");
								}, 2000);

							}
							else if (qData[0].type == "text" && qData[0].languageCode == "en") {
								setTimeout(function () {
									// alert('en text qui')
									$("#userInput").attr("placeholder", "Type Here");
								}, 5);

							}
							else if (qData[0].type == "text" && qData[0].languageCode == "it") {
								// alert('it text qui')
								setTimeout(function () {
									$("#userInput").attr("placeholder", "digita qui");
								}, 5);
							} else if (qData[0].title == "contacting_tutor" && qData[0].languageCode == "it") {
								setTimeout(function () {
									$("#userInput").attr("placeholder", "seleziona un'opzione");
								}, 2000);
							}

							var pattern = '';
							// if(count == 10){
							// 	$('#messages').append('<div class="message to ready">'+qData[0].question+'</div>').animate({ scrollTop: $("#messages").offset().top + 600 }, 600);
							// }
							console.log('======qData.length;=========', qData, count)
							for (var i = 0; i < qData.length; i++) {
								if (qData[i].title == 'email') {
									pattern = "^[a-zA-Z0-9.!#$%&’*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$";
								}
								newQuestion = qData[i].question;
								count = qData[i].question_num;
								var questionTitle = qData[i].title;
								newQuestion = newQuestion.replace("{name}", answer);

								if (qData[i].no_answer == 1) {
									convState.current.next = convState.newState({
										type: 'text',
										noAnswer: true,
										name: questionTitle,
										questions: [newQuestion],
									});
									lastNext = 1;
								} else {
									// console.log('====last next========', lastNext, b, count)
									if (lastNext == 1) {
										lastNext = 0;
										if (qData[i].type == 'text') {
											convState.current.next.next = convState.newState({
												type: 'text',
												name: questionTitle,
												pattern: pattern,
												questions: [newQuestion],
											});
										} else {
											console.log('==== select next========', lastNext, count, {
												type: 'select',
												name: questionTitle,
												questions: [newQuestion],
												answers: qData[i].options
											})
											convState.current.next.next = convState.newState({
												type: 'select',
												name: questionTitle,
												questions: [newQuestion],
												answers: qData[i].options
											});
										}
									} else {
										if (qData[i].type == 'text') {
											console.log('==== hdshdhfdhlast next========', lastNext, count, {
												type: 'text',
												pattern: pattern,
												name: questionTitle,
												questions: [newQuestion],
											})
											convState.current.next = convState.newState({
												type: 'text',
												pattern: pattern,
												name: questionTitle,
												questions: [newQuestion],
											});

										} else {
											answersOption = qData[i].options;
											convState.current.next = convState.newState({
												type: 'select',
												name: questionTitle,
												questions: [newQuestion],
												answers: answersOption
											});
										}
									}
								}
							}
						}
					});
					setTimeout(ready, Math.random() * 500 + 500);
				}
				count++;
				console.log('=====get_question=end in =========', count, convState.current.next)
			}
		});
	</script>
</body>

</html>